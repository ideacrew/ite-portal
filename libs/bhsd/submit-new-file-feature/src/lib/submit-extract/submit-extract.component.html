<h1>Submit New Behavioral Health Supplemental Data (BHSD) File</h1>
<form [formGroup]="extractForm">
  <h2>Select BHSD Reporting Period</h2>
  <p *ngIf="extractForm.errors && extractForm.errors['coveragePeriodTooLong']">
    The coverage period must be 12 months or shorter.
  </p>
  <p *ngIf="extractForm.errors && extractForm.errors['startDateAfterEndDate']">
    The coverage start date must be before the coverage end date.
  </p>
  <div class="coverage-period-selection">
    <div class="input-group">
      <label for="coverage-start">Start Date</label>
      <input
        type="date"
        name="coverage-start"
        id="coverage-start"
        formControlName="coverage_start"
      />
      <ng-container *ngIf="coverage_start.errors && coverage_start.dirty">
        <div class="error-message">
          <p *ngIf="coverage_start.errors['required']">
            Coverage start date is required.
          </p>
          <p *ngIf="coverage_start.errors['dateInFuture']">
            Coverage start date cannot be in the future.
          </p>
          <p
            *ngIf="
              extractForm.errors &&
              extractForm.errors['dataExtractedWithinCoveragePeriod']
            "
          >
            Coverage start date must be earlier than coverage end date.
          </p>
        </div>
      </ng-container>
    </div>
    <div class="input-group">
      <label for="coverage-end">End Date</label>
      <input
        type="date"
        name="coverage-end"
        id="coverage-end"
        formControlName="coverage_end"
      />
      <ng-container *ngIf="coverage_end.errors && coverage_end.dirty">
        <div class="error-message">
          <p *ngIf="coverage_end.errors['required']">
            Coverage end date is required.
          </p>
          <p *ngIf="coverage_end.errors['dateInFuture']">
            Coverage end date cannot be in the future.
          </p>
        </div>
      </ng-container>
    </div>
  </div>

  <h2>BHSD Extract Date</h2>
  <div class="input-group">
    <label for="extract-date">Date BHSD was Extracted from EHR System</label>
    <input
      type="date"
      name="extract-date"
      id="extract-date"
      formControlName="extracted_on"
      data-cy="extract-date"
    />
    <ng-container *ngIf="extracted_on.errors && extracted_on.dirty">
      <div class="error-message">
        <p *ngIf="extracted_on.errors['required']">
          Extracted on date is required.
        </p>
        <p *ngIf="extracted_on.errors['dateInFuture']">
          Extracted on date cannot in the future.
        </p>
      </div>
    </ng-container>
    <p
      data-cy="extract-date-error"
      *ngIf="
        extractForm.errors &&
        extractForm.errors['dataExtractedWithinCoveragePeriod']
      "
    >
      Extracted on date must be after coverage period.
    </p>
  </div>
  <div class="input-group">
    <label for="file-upload"><h2>Choose BHSD CSV File</h2></label>
    <input
      #fileInput
      type="file"
      name="file-upload"
      id="file-upload"
      accept="text/csv"
      (change)="fileSelected(fileInput.files)"
      data-cy="file-upload"
    />
  </div>
  <ng-container *ngIf="records.errors">
    <div class="error-message">
      <p *ngIf="records.errors['required']">
        A csv file must be selected to continue submission.
      </p>
      <p *ngIf="records.errors['notValidCsv']">
        The selected csv file is not valid.
      </p>
    </div>
  </ng-container>
  <button
    class="button submit-button"
    [disabled]="extractForm.status === 'INVALID' || (sendingData$ | async)"
    type="button"
    (click)="sendData()"
    data-cy="submit-extract"
  >
    {{ (sendingData$ | async) ? 'Sending Extract...' : 'Submit' }}
  </button>
</form>

<div class="result">{{ result$ | async }}</div>

<div *ngIf="debug" class="debug-container">
  <div class="column">
    <h3>Form Value:</h3>
    <pre
      >{{ extractForm.value | json }}
    </pre>
  </div>
  <div class="column">
    <h3>Form Errors:</h3>
    <pre
      >{{ extractForm.errors | json }} {{ extractForm.status }}
    </pre>
  </div>
</div>

<!-- <button class="debug-toggle" type="button" (click)="debug = !debug">
  Debugging {{ debug ? '❌' : '✅' }}
</button> -->
